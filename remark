#!/bin/bash

# 1. Calculates the current timestamp.
# 2. Creates a temporary file with the layout and title header.
# 3. Opens a new editor on this file so one can write a post.
# 4. Detects abort based on exit status or file contents.
# 5. Generates a filename based on the title.
# 6. Saves the file in the _posts directory.
# 7. Commits the file using the title.
# 8. Pushes the repo.

HERE="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
TEMP_FILE="$HERE/temp.md"

# Recovery mode: retry publishing if previous attempt failed
if [ "$1" = "--recover" ]; then
    cd "$HERE"
    
    # Check for staged files in _posts
    staged=$(git diff --cached --name-only -- "_posts/")
    if [ -n "$staged" ]; then
        echo "Found staged file: $staged"
        # Extract title from the staged post file
        staged_file=$(echo "$staged" | head -1)
        title=$(grep '^title:' "$staged_file" | sed 's/^title: *"\(.*\)"$/\1/')
        if [ -z "$title" ]; then
            echo "Error: Could not extract title from $staged_file"
            exit 1
        fi
        echo "Committing with title: $title"
        git commit -m "$title"
        if [ $? -ne 0 ]; then
            echo "Error: git commit failed"
            exit 1
        fi
    fi
    
    # Check for unpushed commits
    unpushed=$(git log origin/main..HEAD --oneline 2>/dev/null)
    if [ -n "$unpushed" ]; then
        echo "Pushing unpushed commits..."
        git push
        if [ $? -ne 0 ]; then
            echo "Error: git push failed"
            exit 1
        fi
        echo "Published!"
    elif [ -z "$staged" ]; then
        echo "Nothing to recover - no staged files or unpushed commits"
    else
        echo "Published!"
    fi
    exit 0
fi

# Check if title was provided
if [ -z "$1" ]; then
    echo "Usage: $0 <title>"
    echo "       $0 --recover  (retry after a failed publish)"
    exit 1
fi

timestamp=$(date +%Y-%m-%d)
title="$*"

echo "---
layout: default
title: \"$title\"
---
" > $TEMP_FILE

# Open editor
EDITOR="${EDITOR:-vim}"
$EDITOR "$TEMP_FILE"

# Check if file was saved and has content beyond front matter
# Front matter is 4 lines, so we need at least 5 non-empty lines
non_empty_lines=$(grep -v '^[[:space:]]*$' "$TEMP_FILE" | wc -l | tr -d ' ')

if [ "$non_empty_lines" -le "4" ]; then
    echo "Aborted: No content written"
    rm "$TEMP_FILE"
    exit 0
fi

# Extract title from front matter (override original parameter if changed)
extracted_title=$(grep '^title:' "$TEMP_FILE" | sed 's/^title: *"\(.*\)"$/\1/')
if [ -n "$extracted_title" ]; then
    title="$extracted_title"
fi

# Generate slug from title (lowercase, spaces to hyphens, remove special chars)
slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')

# Create final filename
FINAL_FILE="$HERE/_posts/$timestamp-$slug.md"

# Move temp file to final location
mv "$TEMP_FILE" "$FINAL_FILE"

echo "Created: $FINAL_FILE"

# Commit and push
cd "$HERE"
git add "$FINAL_FILE"
if [ $? -ne 0 ]; then
    echo "Error: git add failed"
    exit 1
fi

git commit -m "$title"
if [ $? -ne 0 ]; then
    echo "Error: git commit failed. File is staged but not committed."
    echo "Run '$0 --recover' to retry."
    exit 1
fi

git push
if [ $? -ne 0 ]; then
    echo "Error: git push failed. Commit succeeded but not pushed."
    echo "Run '$0 --recover' to retry."
    exit 1
fi

echo "Published!"
